<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Adelaide 区域配送地图</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; width: 100%; height: 100%; }
    #sidebar { position: absolute; top: 10px; right: 10px; width: 250px; max-height: 90%; overflow-y: auto; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 4px; box-shadow: 0 0 6px rgba(0,0,0,0.3); }
    .zone-item { margin-bottom: 8px; display: flex; align-items: center; }
    .zone-label { padding: 4px 8px; border: none; cursor: pointer; background: #eee; border-radius: 3px; margin-right: 5px; flex-shrink: 0; }
    .zone-input { flex: 1; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h4>配送区域负责人</h4>
    <div id="list"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 1. 初始化地图
    const map = L.map('map').setView([-34.9285, 138.6007], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let zoneLayers = {};
    let sheetData = {};

    // 2. 加载 GeoJSON（通过 AllOrigins 从 Google Drive 拉取）
    const rawUrl = 'https://drive.google.com/uc?export=download&id=17FaPBXbCJsSYoNVi0xa3zfSg5--AvtoA';
    const GEOJSON_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(rawUrl);
    fetch(GEOJSON_URL)
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: feature => {
            const zone = feature.properties.zone;
            return { color: '#000', weight: 1, fillOpacity: 0.5, fillColor: getColor(zone) };
          },
          onEachFeature: (feature, layer) => {
            const z = feature.properties.zone;
            if (!zoneLayers[z]) {
              zoneLayers[z] = L.layerGroup().addTo(map);
            }
            zoneLayers[z].addLayer(layer);
          }
        }).addTo(map);
      })
      .catch(err => console.error('Failed to load GeoJSON via proxy:', err));

    // 3. 使用 Google Apps Script API 获取和保存数据
    const GAS_URL = 'https://script.google.com/macros/s/1saIS-f3RcV2PbIvboZvDGXIq1EenqDmfjcMGQm30NSEAsi7ZcSUE_eUD/exec';

    // 加载数据并渲染侧边栏
    function loadData() {
      return fetch(GAS_URL).then(res => res.json());
    }

    loadData().then(rows => {
      const list = document.getElementById('list');
      rows.forEach(row => {
        const zone = row.zone;
        const driver = row.responsible;
        sheetData[zone] = driver;

        const div = document.createElement('div');
        div.className = 'zone-item';

        const btn = document.createElement('button');
        btn.className = 'zone-label';
        btn.textContent = zone;
        btn.onclick = () => zoomToZone(zone);

        const input = document.createElement('input');
        input.type = 'text';
        input.value = driver;
        input.className = 'zone-input';
        input.oninput = () => saveDriver(zone, input.value);

        div.appendChild(btn);
        div.appendChild(input);
        list.appendChild(div);
      });
    }).catch(err => console.error('Failed to load sheet data:', err));

    // 保存到 Google 表格
    function saveDriver(zone, newDriver) {
      fetch(`${GAS_URL}?zone=${zone}&responsible=${encodeURIComponent(newDriver)}`, {
        method: 'POST'
      })
      .then(r => r.json())
      .then(data => {
        if (!data.success) console.error('保存失败', data);
      })
      .catch(err => console.error('保存请求失败:', err));
    }

    // 随机色彩映射
    function getColor(zone) {
      const hash = zone.split('').reduce((h, c) => h + c.charCodeAt(0), 0);
      const color = (hash * 1234567 % 0xFFFFFF).toString(16).padStart(6, '0');
      return '#' + color;
    }

    // 缩放到指定 zone
    function zoomToZone(zone) {
      const layer = zoneLayers[zone];
      if (layer) {
        map.fitBounds(layer.getBounds());
      }
    }
  </script>
</body>
</html>
